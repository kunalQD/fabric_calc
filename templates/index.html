<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Order ‚Äì Quilt & Drapes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f7f6; font-size:14px; }
.container-max { max-width:1100px; margin:auto; }

.top-bar {
  background:#1a1a1a; color:#fff; padding:.75rem 1rem;
}

.card { border-radius:14px; }
.section-header {
  font-weight:600; border-bottom:1px solid #dee2e6; padding-bottom:.4rem;
}

.table thead th { white-space:nowrap; }
</style>
</head>

<body>

<div class="top-bar d-flex justify-content-between align-items-center">
  <div class="d-flex gap-2 align-items-center">
    <a href="/dashboard" class="btn btn-outline-light btn-sm">‚Üê Dashboard</a>
    <strong id="pageTitle">New Order</strong>
  </div>
  <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
</div>

<div class="container-max px-3 my-4">

<!-- CUSTOMER -->
<div class="card shadow-sm mb-3">
<div class="card-body">
<h6 class="section-header mb-3">Customer Details</h6>

<div class="row g-3">
  <div class="col-md-3">
    <label class="form-label">Branch</label>
    <select id="showroom" class="form-select">
      <option>Anna Nagar</option>
      <option>Valasaravakkam</option>
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Name</label>
    <input id="custName" class="form-control">
  </div>

  <div class="col-md-3">
    <label class="form-label">Phone</label>
    <input id="custPhone" class="form-control">
  </div>

  <div class="col-md-3">
    <label class="form-label">Address</label>
    <input id="custAddr" class="form-control">
  </div>

  <div class="col-md-3">
    <label class="form-label">Status</label>
    <select id="orderStatus" class="form-select">
      <option>Pending</option>
      <option>Cutting</option>
      <option>Stitching</option>
      <option>Completed</option>
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Due Date</label>
    <input type="date" id="dueDate" class="form-control">
  </div>
</div>
</div>
</div>

<!-- ADD WINDOW -->
<div class="card shadow-sm mb-3">
<div class="card-body">
<h6 class="section-header mb-3">Add Window</h6>

<div class="row g-3">
  <div class="col-md-6">
    <label class="form-label">Window Name</label>
    <input id="winName" class="form-control">
  </div>

  <div class="col-md-6">
    <label class="form-label">Description</label>
    <input id="winDesc" class="form-control">
  </div>

  <div class="col-md-4">
    <label class="form-label">Stitch</label>
    <select id="stitch" class="form-select">
      <option>Pleated</option>
      <option>Ripple</option>
      <option>Eyelet</option>
      <option>Roman Blinds 48"</option>
      <option>Roman Blinds 54"</option>
      <option>Blinds (Regular)</option>
    </select>
  </div>

  <div class="col-md-4">
    <label class="form-label">Lining</label>
    <select id="lining" class="form-select">
      <option>No Lining</option>
      <option>Normal Lining</option>
      <option>B/O Lining</option>
    </select>
  </div>

  <div class="col-md-2">
    <label class="form-label">Width (in)</label>
    <input id="width" type="number" class="form-control">
  </div>

  <div class="col-md-2">
    <label class="form-label">Height (in)</label>
    <input id="height" type="number" class="form-control">
  </div>

  <div class="col-12">
    <div class="form-check form-switch mt-2">
      <input class="form-check-input" type="checkbox" id="isDouble">
      <label class="form-check-label">Double Layer</label>
    </div>
  </div>

  <div class="col-12">
    <label class="form-label">Tailor Notes</label>
    <textarea id="winNotes" rows="2" class="form-control"></textarea>
  </div>

  <div class="col-12">
  <label class="form-label">Window Images</label>
  <input type="file" id="winImages" class="form-control" multiple>
</div>

</div>

<div class="row g-2 mt-4">
  <div class="col-md-6">
    <button class="btn btn-success w-100" onclick="addOrUpdateWindow()">Add / Update Window</button>
  </div>
  <div class="col-md-6">
    <button class="btn btn-outline-secondary w-100" onclick="resetForm()">Clear</button>
  </div>
</div>

</div>
</div>

<!-- TABLE -->
<div class="card shadow-sm mb-3">
<div class="table-responsive">
<table class="table table-sm table-bordered mb-0" id="windowTable">
<thead class="table-dark">
<tr>
  <th>Window</th>
  <th>Qty</th>
  <th>Panels</th>
  <th>Track / SQFT</th>
  <th>Width</th>
  <th>Height</th>
  <th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<button class="btn btn-dark w-100 py-3" onclick="saveOrder()">SAVE ORDER</button>

<button class="btn btn-outline-primary w-100 py-2 mt-2"
  onclick="window.open(`/api/orders/${currentOrderId}/pdf`, `_blank`)">
  PRINT ORDER
</button>

</div>
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Window Images</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="imageCarousel" class="carousel slide">
          <div class="carousel-inner" id="carouselInner"></div>
          <button class="carousel-control-prev" data-bs-target="#imageCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" data-bs-target="#imageCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let entries=[], editIndex=null, isEditMode=false, currentOrderId=null;

/* ---------- CALC ---------- */
function calcPanels(s,w){
  if(s==="Pleated") return Math.round(w/18);
  if(s==="Ripple") return Math.round(w/20);
  if(s==="Eyelet") return Math.round(w/24);
  return 1;
}
function calcQty(s,w,h){
  let hf=(h+14)/39;
  return Number((calcPanels(s,w)*hf).toFixed(2));
}
function calcSqft(s,w,h){
  if(s.includes("Roman")||s.includes("Blinds"))
    return Number(((Math.ceil(w/12*2)/2)*(Math.ceil(h/12*2)/2)).toFixed(2));
  return 0;
}
function calcTrack(s,w){
  if(s.includes("Roman")||s.includes("Blinds")) return 0;
  return Math.ceil((w/12)*2)/2;
}

/* ---------- LOAD ORDER ---------- */
document.addEventListener("DOMContentLoaded",async()=>{
  const p=new URLSearchParams(location.search);
  if(p.has("order_id")){
    currentOrderId=p.get("order_id");
    isEditMode=true;
    pageTitle.innerText="Edit Order";
    const o=await fetch(`/api/orders/${currentOrderId}`).then(r=>r.json());
    showroom.value=o.showroom;
    custName.value=o.name;
    custPhone.value=o.phone;
    custAddr.value=o.address;
    orderStatus.value=o.status;
    dueDate.value=o.due_date||"";
    entries=o.entries||[];
    render();
  }
});

/* ---------- ADD / UPDATE ---------- */
function addOrUpdateWindow(){
  const w=Number(width.value)||0;
  const h=Number(height.value)||0;
  const s=stitch.value;

  const baseEntry={
    Stitch: s,
    Lining: lining.value,
    Width: w,
    Height: h,
    Panels: calcPanels(s,w),
    Quantity: calcQty(s,w,h),
    Track: calcTrack(s,w),
    SQFT: calcSqft(s,w,h),
    Notes: winNotes.value,
    Images: [...winImages.files]
  };

  if(editIndex!==null){
    entries.splice(editIndex,1);
    editIndex=null;
  }

  if(isDouble.checked){
    entries.push({ Window: winName.value+" - Layer 1", ...baseEntry });
    entries.push({ Window: winName.value+" - Layer 2", ...baseEntry });
  } else {
    entries.push({ Window: winName.value, ...baseEntry });
  }

  render();
  resetForm();
}

/* ---------- EDIT ---------- */
function edit(i){
  editIndex=i;
  const e=entries[i];
  winName.value=e.Window;
  stitch.value=e.Stitch;
  lining.value=e.Lining;
  width.value=e.Width;
  height.value=e.Height;
  winNotes.value=e.Notes||"";
}

/* ---------- RENDER ---------- */
function render(){
  const tbody=windowTable.querySelector("tbody");
  tbody.innerHTML="";

  entries.forEach((e,i)=>{
    const trackOrSqft =
      e.Track && e.Track>0 ? `${e.Track} ft` : `${e.SQFT} sqft`;

    tbody.innerHTML+=`
    <tr>
      <td>${e.Window}</td>
      <td><strong>${e.Quantity.toFixed(2)}</strong></td>
      <td>${e.Panels}</td>
      <td>${trackOrSqft}</td>
      <td>${e.Width}</td>
      <td>${e.Height}</td>
      <td>
        ${Array.isArray(e.Images) && e.Images.length > 0 ? `<button class="btn btn-info btn-sm me-1" onclick="viewImages(${i})">Images</button>`: ""}
        <button class="btn btn-warning btn-sm" onclick="edit(${i})">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="entries.splice(${i},1);render()">X</button>
      </td>
    </tr>`;
  });
}

/* ---------- RESET ---------- */
function resetForm(){
  winName.value=winDesc.value=winNotes.value="";
  width.value=height.value=0;
  lining.value="No Lining";
}

/* ---------- SAVE ---------- */
async function saveOrder(){
  const fd = new FormData();

  fd.append("name", custName.value);
  fd.append("phone", custPhone.value);
  fd.append("address", custAddr.value);
  fd.append("showroom", showroom.value);
  fd.append("status", orderStatus.value);
  fd.append("due_date", dueDate.value);

  // üî¥ IMPORTANT: send entries WITHOUT file objects
  const cleanEntries = entries.map(e => {
    const copy = { ...e };
    delete copy.Images;     // remove frontend files
    delete copy._files;     // safety (if exists)
    return copy;
  });

  fd.append("entries", JSON.stringify(cleanEntries));

  // ‚úÖ Append files separately (THIS WAS MISSING)
  entries.forEach((e, i) => {
    if (e.Images && e.Images.length) {
      e.Images.forEach(file => {
        if (file instanceof File) {
          fd.append(`images_${i}`, file);
        }
      });
    }
  });

  await fetch(
    isEditMode ? `/api/orders/${currentOrderId}` : "/api/orders",
    {
      method: isEditMode ? "PUT" : "POST",
      body: fd
    }
  );

  location.href = "/dashboard";
}

function viewImages(index) {
  const imgs = entries[index].Images || [];
  const carousel = document.getElementById("carouselInner");

  carousel.innerHTML = imgs.map((img, i) => {
    const src = typeof img === "string"
      ? `/api/image/${img.replace("gridfs:", "")}`
      : URL.createObjectURL(img);

    return `
      <div class="carousel-item ${i === 0 ? "active" : ""}">
        <img src="${src}" class="d-block w-100 rounded">
      </div>
    `;
  }).join("");

  new bootstrap.Modal(document.getElementById("imageModal")).show();
}

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
